<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة توثيق الحسابات</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f5f6fa;
            direction: rtl;
        }
        :root {
            --navbar-height: 70px;
            --primary-color: #1a73e8;
            --secondary-color: #ff4444;
            --background-color: #f5f6fa;
            --card-bg: #ffffff;
            --text-color: #1c2526;
            --hover-color: #1557b0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --verified-color: #4CAF50;
        }
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #4a90e2);
            color: white;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: var(--shadow);
            height: var(--navbar-height);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        .navbar .title {
            font-size: 22px;
            font-weight: 700;
        }
        .navbar .admin-actions {
            display: flex;
            gap: 15px;
        }
        .navbar button {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .navbar button:hover {
            background: #e03b3b;
            transform: scale(1.05);
        }
        .container {
            padding-top: calc(var(--navbar-height) + 20px);
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        .search-container input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e4e8;
            border-radius: 30px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
            background: var(--card-bg);
            color: var(--text-color);
        }
        .search-container input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
        }
        .search-container button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        .search-container button:hover {
            background: var(--hover-color);
            transform: translateY(-2px);
        }
        .users-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        .users-table th, .users-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #e0e4e8;
        }
        .users-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        .users-table tr:hover {
            background: rgba(26, 115, 232, 0.05);
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-left: 5px;
            font-size: 14px;
        }
        .verify-btn {
            background: var(--verified-color);
            color: white;
        }
        .unverify-btn {
            background: var(--warning-color);
            color: #212529;
        }
        .ban-btn {
            background: var(--danger-color);
            color: white;
        }
        .action-btn:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }
        .verified-badge {
            color: var(--verified-color);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .verified-badge i {
            font-size: 16px;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }
        .pagination button {
            padding: 8px 15px;
            border: 1px solid #e0e4e8;
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .pagination button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .pagination button:hover:not(.active) {
            background: #e0e4e8;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 500px;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-content h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        .modal-content .form-group {
            margin-bottom: 15px;
        }
        .modal-content label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-color);
        }
        .modal-content input, .modal-content select, .modal-content textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e4e8;
            border-radius: 8px;
            font-size: 16px;
            background: var(--card-bg);
            color: var(--text-color);
        }
        .modal-content .buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-content .buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .modal-content .buttons .confirm-btn {
            background: var(--primary-color);
            color: white;
        }
        .modal-content .buttons .cancel-btn {
            background: #e0e4e8;
            color: var(--text-color);
        }
        .success-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 3000;
            display: none;
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-active {
            background-color: #e6f7ee;
            color: var(--verified-color);
        }
        .status-banned {
            background-color: #fee;
            color: var(--danger-color);
        }
        .status-pending {
            background-color: #fff8e6;
            color: var(--warning-color);
        }
        .time-remaining {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .duration-inputs {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .duration-inputs input {
            flex: 1;
            padding: 8px;
            border: 1px solid #e0e4e8;
            border-radius: 8px;
            text-align: center;
        }
        .duration-inputs label {
            font-size: 12px;
            text-align: center;
        }
        .duration-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                height: auto;
                padding: 10px;
            }
            .navbar .title {
                margin-bottom: 10px;
            }
            .navbar .admin-actions {
                width: 100%;
                justify-content: space-between;
            }
            .search-container {
                flex-direction: column;
            }
            .search-container button {
                width: 100%;
                justify-content: center;
            }
            .users-table {
                display: block;
                overflow-x: auto;
            }
            .users-table th, 
            .users-table td {
                padding: 10px;
                font-size: 14px;
            }
            .action-btn {
                margin-bottom: 5px;
                display: block;
                width: 100%;
            }
            .duration-inputs {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
                padding-top: calc(var(--navbar-height) + 10px);
            }
            .search-container {
                padding: 10px;
            }
            .search-container input {
                padding: 10px 15px;
            }
            .search-container button {
                padding: 10px 15px;
            }
            .modal-content {
                width: 95%;
                padding: 15px;
            }
            .pagination button {
                padding: 5px 10px;
            }
        }
    </style>
</head>
<body>
<div class="navbar">
    <div class="title">لوحة توثيق الحسابات</div>
    <div class="admin-actions">
        <button onclick="refreshData()"><i class="fas fa-sync-alt"></i> تحديث البيانات</button>
    </div>
</div>

<div class="container">
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="ابحث عن مستخدم بالاسم أو البريد الإلكتروني...">
        <button onclick="searchUsers()"><i class="fas fa-search"></i> بحث</button>
    </div>

    <div style="overflow-x: auto;">
        <table class="users-table">
            <thead>
                <tr>
                    <th>الصورة</th>
                    <th>الاسم</th>
                    <th>البريد الإلكتروني</th>
                    <th>حالة التوثيق</th>
                    <th>حالة الحساب</th>
                    <th>تاريخ التسجيل</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                <!-- سيتم ملؤها بالبيانات -->
            </tbody>
        </table>
    </div>

    <div class="pagination" id="pagination">
        <!-- سيتم ملؤها بالبيانات -->
    </div>
</div>

<!-- Modal for Verify User -->
<div id="verifyUserModal" class="modal">
    <div class="modal-content">
        <h3>توثيق الحساب</h3>
        <div class="form-group">
            <label>الاسم الكامل</label>
            <input type="text" id="verifyUserName" readonly>
        </div>
        <div class="form-group">
            <label>البريد الإلكتروني</label>
            <input type="email" id="verifyUserEmail" readonly>
        </div>
        <div class="form-group">
            <label>ملاحظات التوثيق</label>
            <textarea id="verifyUserNotes" rows="3" placeholder="أضف ملاحظات حول عملية التوثيق (اختياري)"></textarea>
        </div>
        <div class="form-group">
            <label>مدة التوثيق</label>
            <div class="duration-inputs">
                <div class="duration-container">
                    <input type="number" id="verifyDays" min="0" placeholder="0">
                    <label>أيام</label>
                </div>
                <div class="duration-container">
                    <input type="number" id="verifyHours" min="0" placeholder="0">
                    <label>ساعات</label>
                </div>
                <div class="duration-container">
                    <input type="number" id="verifyMinutes" min="0" placeholder="0">
                    <label>دقائق</label>
                </div>
            </div>
        </div>
        <div class="buttons">
            <button class="cancel-btn" onclick="closeModal('verifyUserModal')">إلغاء</button>
            <button class="confirm-btn" onclick="confirmVerifyUser()"><i class="fas fa-check-circle"></i> تأكيد التوثيق</button>
        </div>
    </div>
</div>

<!-- Modal for Unverify User -->
<div id="unverifyUserModal" class="modal">
    <div class="modal-content">
        <h3>إلغاء توثيق الحساب</h3>
        <div class="form-group">
            <label>الاسم الكامل</label>
            <input type="text" id="unverifyUserName" readonly>
        </div>
        <div class="form-group">
            <label>سبب الإلغاء</label>
            <select id="unverifyReason">
                <option value="document_expired">انتهت صلاحية المستندات</option>
                <option value="document_invalid">مستندات غير صالحة</option>
                <option value="suspicious_activity">نشاط مشبوه</option>
                <option value="other">أسباب أخرى</option>
            </select>
        </div>
        <div class="form-group">
            <label>ملاحظات</label>
            <textarea id="unverifyNotes" rows="3" placeholder="أضف ملاحظات حول سبب الإلغاء"></textarea>
        </div>
        <div class="buttons">
            <button class="cancel-btn" onclick="closeModal('unverifyUserModal')">إلغاء</button>
            <button class="confirm-btn delete-btn" onclick="confirmUnverifyUser()"><i class="fas fa-times-circle"></i> تأكيد الإلغاء</button>
        </div>
    </div>
</div>

<!-- Success Message -->
<div class="success-message" id="successMessage">
    <i class="fas fa-check-circle"></i> <span id="successMessageText"></span>
</div>

<script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-database-compat.js"></script>
<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyC88Ka051_b_ErfIMWupWYP_O0OhJskKVk",
        authDomain: "prog-320ec.firebaseapp.com",
        databaseURL: "https://prog-320ec-default-rtdb.firebaseio.com",
        projectId: "prog-320ec",
        storageBucket: "prog-320ec.appspot.com",
        messagingSenderId: "32297321960",
        appId: "1:32297321960:android:8ac5bb695f1802b4c4505d"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Global Variables
    let currentPage = 1;
    const usersPerPage = 10;
    let allUsers = [];
    let filteredUsers = [];
    let currentEditingUserId = null;
    let verificationTimers = {};

    // Initialize the dashboard
    window.onload = function() {
        loadUsers();
        setupRealTimeListeners();
    };

    // Set up real-time listeners for users and posts
    function setupRealTimeListeners() {
        // Listen for user verification changes
        db.ref('users').on('value', (snapshot) => {
            const users = snapshot.val() || {};
            allUsers = Object.entries(users).map(([id, user]) => ({
                id,
                ...user,
                createdAt: user.createdAt || 0,
                verified: user.verified || false,
                verificationData: user.verificationData || null,
                banned: user.banned || false
            })).sort((a, b) => b.createdAt - a.createdAt);
            
            filteredUsers = [...allUsers];
            renderUsers();
            
            // Update verification timers
            updateAllVerificationTimers();
        });

        // Listen for new posts to immediately update verification status
        db.ref('posts').on('child_added', (snapshot) => {
            const post = snapshot.val();
            if (post && post.authorId) {
                const user = allUsers.find(u => u.id === post.authorId);
                if (user && user.verified) {
                    // Update the new post with verification status immediately
                    db.ref(`posts/${snapshot.key}/authorVerified`).set(true);
                }
            }
        });
    }

    // Update all verification timers
    function updateAllVerificationTimers() {
        // Clear all existing timers
        Object.keys(verificationTimers).forEach(userId => {
            clearInterval(verificationTimers[userId]);
        });
        verificationTimers = {};
        
        // Set up new timers for verified users with expiration
        allUsers.forEach(user => {
            if (user.verified && user.verificationData && user.verificationData.expiresAt) {
                setupVerificationTimer(user.id);
            }
        });
    }

    // Set up a timer for a specific user's verification
    function setupVerificationTimer(userId) {
        // Clear existing timer if any
        if (verificationTimers[userId]) {
            clearInterval(verificationTimers[userId]);
        }
        
        // Set up new timer
        verificationTimers[userId] = setInterval(() => {
            updateVerificationStatus(userId);
        }, 1000);
    }

    // Update verification status for a user
    function updateVerificationStatus(userId) {
        const user = allUsers.find(u => u.id === userId);
        if (!user || !user.verified || !user.verificationData || !user.verificationData.expiresAt) {
            return;
        }
        
        const now = Date.now();
        const expiresAt = user.verificationData.expiresAt;
        
        if (now >= expiresAt) {
            // Verification expired, automatically unverify
            db.ref(`users/${userId}`).update({
                verified: false,
                verificationData: {
                    ...user.verificationData,
                    expired: true,
                    unverifiedAt: now,
                    unverifiedBy: 'system'
                }
            });
            
            // Update verification in all related data
            updateUserVerificationInPosts(userId, false);
            updateUserVerificationInComments(userId, false);
            updateUserVerificationInGroups(userId, false);
            updateUserVerificationInMessages(userId, false);
            
            // Clear the timer
            clearInterval(verificationTimers[userId]);
            delete verificationTimers[userId];
        }
    }

    // Load all users with verification status
    async function loadUsers() {
        try {
            document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center;">جاري تحميل بيانات المستخدمين...</td></tr>';
            
            const usersSnapshot = await db.ref('users').once('value');
            const users = usersSnapshot.val() || {};
            
            // Convert to array and sort by creation date
            allUsers = Object.entries(users).map(([id, user]) => ({
                id,
                ...user,
                createdAt: user.createdAt || 0,
                verified: user.verified || false,
                verificationData: user.verificationData || null,
                banned: user.banned || false
            })).sort((a, b) => b.createdAt - a.createdAt);
            
            filteredUsers = [...allUsers];
            renderUsers();
            
            // Update verification timers
            updateAllVerificationTimers();
            
        } catch (error) {
            console.error('Error loading users:', error);
            showError('حدث خطأ أثناء تحميل قائمة المستخدمين');
        }
    }

    // Render users to the table with pagination
    function renderUsers() {
        const startIndex = (currentPage - 1) * usersPerPage;
        const endIndex = startIndex + usersPerPage;
        const usersToShow = filteredUsers.slice(startIndex, endIndex);
        
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';
        
        if (usersToShow.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">لا توجد بيانات لعرضها</td></tr>';
            return;
        }
        
        usersToShow.forEach(user => {
            const tr = document.createElement('tr');
            
            // Verification status
            let verificationStatus = '';
            if (user.verified) {
                let timeRemaining = '';
                if (user.verificationData?.expiresAt) {
                    const remainingTime = calculateRemainingTime(user.verificationData.expiresAt);
                    timeRemaining = `<div class="time-remaining">${remainingTime}</div>`;
                }
                
                verificationStatus = `
                    <div class="verified-badge">
                        <i class="fas fa-check-circle"></i>
                        <span>موثق</span>
                        ${timeRemaining}
                    </div>
                `;
            } else {
                verificationStatus = '<span style="color: #6b7280;">غير موثق</span>';
            }
            
            // Account status
            let accountStatus = '';
            if (user.banned) {
                accountStatus = '<span class="status-badge status-banned"><i class="fas fa-ban"></i> محظور</span>';
            } else {
                accountStatus = '<span class="status-badge status-active"><i class="fas fa-check"></i> نشط</span>';
            }
            
            tr.innerHTML = `
                <td><img src="${user.photoURL || 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&s=40'}" class="user-avatar" alt="${user.displayName || 'مستخدم'}"></td>
                <td>${user.displayName || 'مستخدم'} ${user.verified ? '<span class="verified-badge"><i class="fas fa-check-circle"></i></span>' : ''}</td>
                <td>${user.email || 'غير معروف'}</td>
                <td>${verificationStatus}</td>
                <td>${accountStatus}</td>
                <td>${formatDate(user.createdAt)}</td>
                <td>
                    ${user.verified ? 
                        `<button class="action-btn unverify-btn" onclick="showUnverifyUserModal('${user.id}')"><i class="fas fa-times"></i> إلغاء التوثيق</button>` : 
                        `<button class="action-btn verify-btn" onclick="showVerifyUserModal('${user.id}')"><i class="fas fa-check"></i> توثيق</button>`
                    }
                    <button class="action-btn ban-btn" onclick="toggleBanUser('${user.id}', ${user.banned || false})">
                        <i class="fas fa-${user.banned ? 'unlock' : 'ban'}"></i> ${user.banned ? 'فك الحظر' : 'حظر'}
                    </button>
                </td>
            `;
            
            tbody.appendChild(tr);
        });
        
        // Render pagination
        renderPagination();
    }

    // Calculate remaining time for verification
    function calculateRemainingTime(expiresAt) {
        const now = Date.now();
        const diff = expiresAt - now;
        
        if (diff <= 0) {
            return 'انتهى التوثيق';
        }
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        let result = '';
        if (days > 0) result += `${days} يوم `;
        if (hours > 0) result += `${hours} ساعة `;
        if (minutes > 0) result += `${minutes} دقيقة `;
        if (seconds > 0 && days === 0 && hours === 0) result += `${seconds} ثانية`;
        
        return `متبقي: ${result.trim()}`;
    }

    // Render pagination controls
    function renderPagination() {
        const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        // Previous button
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                renderUsers();
            }
        };
        pagination.appendChild(prevBtn);
        
        // Page buttons
        for (let i = 1; i <= totalPages; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.textContent = i;
            pageBtn.className = currentPage === i ? 'active' : '';
            pageBtn.onclick = () => {
                currentPage = i;
                renderUsers();
            };
            pagination.appendChild(pageBtn);
        }
        
        // Next button
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderUsers();
            }
        };
        pagination.appendChild(nextBtn);
    }

    // Search users by name or email
    function searchUsers() {
        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
        
        if (!searchTerm) {
            filteredUsers = [...allUsers];
        } else {
            filteredUsers = allUsers.filter(user => 
                (user.displayName && user.displayName.toLowerCase().includes(searchTerm)) ||
                (user.email && user.email.toLowerCase().includes(searchTerm))
            );
        }
        
        currentPage = 1;
        renderUsers();
    }

    // Show verify user modal
    function showVerifyUserModal(userId) {
        const user = allUsers.find(u => u.id === userId);
        if (!user) return;
        
        currentEditingUserId = userId;
        document.getElementById('verifyUserName').value = user.displayName || '';
        document.getElementById('verifyUserEmail').value = user.email || '';
        document.getElementById('verifyUserNotes').value = '';
        document.getElementById('verifyDays').value = '';
        document.getElementById('verifyHours').value = '';
        document.getElementById('verifyMinutes').value = '';
        
        openModal('verifyUserModal');
    }

    // Confirm verify user
    async function confirmVerifyUser() {
        const notes = document.getElementById('verifyUserNotes').value.trim();
        const days = parseInt(document.getElementById('verifyDays').value) || 0;
        const hours = parseInt(document.getElementById('verifyHours').value) || 0;
        const minutes = parseInt(document.getElementById('verifyMinutes').value) || 0;
        
        if (days === 0 && hours === 0 && minutes === 0) {
            showError('يجب تحديد مدة التوثيق');
            return;
        }
        
        try {
            const now = Date.now();
            const durationMs = (days * 24 * 60 * 60 * 1000) + 
                              (hours * 60 * 60 * 1000) + 
                              (minutes * 60 * 1000);
            const expiresAt = now + durationMs;
            
            const verificationData = {
                verified: true,
                verificationData: {
                    verifiedAt: now,
                    verifiedBy: 'admin',
                    notes: notes,
                    expiresAt: expiresAt,
                    duration: { days, hours, minutes }
                }
            };
            
            // Update data in Firebase
            await db.ref(`users/${currentEditingUserId}`).update(verificationData);
            
            // Update verification in all existing posts
            await updateUserVerificationInPosts(currentEditingUserId, true);
            
            // Update verification in all existing comments
            await updateUserVerificationInComments(currentEditingUserId, true);
            
            // Update verification in all existing groups
            await updateUserVerificationInGroups(currentEditingUserId, true);
            
            // Update verification in all existing messages
            await updateUserVerificationInMessages(currentEditingUserId, true);
            
            // Set up timer for this verification
            setupVerificationTimer(currentEditingUserId);
            
            // The real-time listener will handle the UI update automatically
            closeModal('verifyUserModal');
            showSuccess('تم توثيق الحساب بنجاح وسيظهر التوثيق في جميع أنحاء الموقع');
            
        } catch (error) {
            console.error('Error verifying user:', error);
            showError('حدث خطأ أثناء توثيق الحساب');
        }
    }

    // Update user verification status in all posts
    async function updateUserVerificationInPosts(userId, isVerified) {
        try {
            const postsSnapshot = await db.ref('posts').once('value');
            const posts = postsSnapshot.val() || {};
            
            const updates = {};
            Object.keys(posts).forEach(postId => {
                if (posts[postId].authorId === userId) {
                    updates[`posts/${postId}/authorVerified`] = isVerified;
                }
            });
            
            if (Object.keys(updates).length > 0) {
                await db.ref().update(updates);
            }
        } catch (error) {
            console.error('Error updating user verification in posts:', error);
        }
    }

    // Update user verification status in all comments
    async function updateUserVerificationInComments(userId, isVerified) {
        try {
            const commentsSnapshot = await db.ref('comments').once('value');
            const comments = commentsSnapshot.val() || {};
            
            const updates = {};
            Object.keys(comments).forEach(commentId => {
                if (comments[commentId].authorId === userId) {
                    updates[`comments/${commentId}/authorVerified`] = isVerified;
                }
            });
            
            if (Object.keys(updates).length > 0) {
                await db.ref().update(updates);
            }
        } catch (error) {
            console.error('Error updating user verification in comments:', error);
        }
    }

    // Update user verification status in all groups
    async function updateUserVerificationInGroups(userId, isVerified) {
        try {
            const groupsSnapshot = await db.ref('groups').once('value');
            const groups = groupsSnapshot.val() || {};
            
            const updates = {};
            Object.keys(groups).forEach(groupId => {
                // Update owner verification status
                if (groups[groupId].ownerId === userId) {
                    updates[`groups/${groupId}/ownerVerified`] = isVerified;
                }
                
                // Update member verification status
                if (groups[groupId].members) {
                    Object.keys(groups[groupId].members).forEach(memberId => {
                        if (memberId === userId) {
                            updates[`groups/${groupId}/members/${memberId}/verified`] = isVerified;
                        }
                    });
                }
            });
            
            if (Object.keys(updates).length > 0) {
                await db.ref().update(updates);
            }
        } catch (error) {
            console.error('Error updating user verification in groups:', error);
        }
    }

    // Update user verification status in all messages
    async function updateUserVerificationInMessages(userId, isVerified) {
        try {
            const messagesSnapshot = await db.ref('messages').once('value');
            const messages = messagesSnapshot.val() || {};
            
            const updates = {};
            Object.keys(messages).forEach(messageId => {
                if (messages[messageId].senderId === userId) {
                    updates[`messages/${messageId}/senderVerified`] = isVerified;
                }
            });
            
            if (Object.keys(updates).length > 0) {
                await db.ref().update(updates);
            }
        } catch (error) {
            console.error('Error updating user verification in messages:', error);
        }
    }

    // Show unverify user modal
    function showUnverifyUserModal(userId) {
        const user = allUsers.find(u => u.id === userId);
        if (!user) return;
        
        currentEditingUserId = userId;
        document.getElementById('unverifyUserName').value = user.displayName || '';
        document.getElementById('unverifyReason').value = 'document_expired';
        document.getElementById('unverifyNotes').value = '';
        
        openModal('unverifyUserModal');
    }

    // Confirm unverify user
    async function confirmUnverifyUser() {
        const reason = document.getElementById('unverifyReason').value;
        const notes = document.getElementById('unverifyNotes').value.trim();
        
        try {
            const user = allUsers.find(u => u.id === currentEditingUserId);
            const verificationData = {
                verified: false,
                verificationData: {
                    ...(user.verificationData || {}),
                    unverifiedAt: Date.now(),
                    unverifiedBy: 'admin',
                    reason: reason,
                    notes: notes
                }
            };
            
            // Update data in Firebase
            await db.ref(`users/${currentEditingUserId}`).update(verificationData);
            
            // Update verification in all existing posts
            await updateUserVerificationInPosts(currentEditingUserId, false);
            
            // Update verification in all existing comments
            await updateUserVerificationInComments(currentEditingUserId, false);
            
            // Update verification in all existing groups
            await updateUserVerificationInGroups(currentEditingUserId, false);
            
            // Update verification in all existing messages
            await updateUserVerificationInMessages(currentEditingUserId, false);
            
            // Clear the timer if exists
            if (verificationTimers[currentEditingUserId]) {
                clearInterval(verificationTimers[currentEditingUserId]);
                delete verificationTimers[currentEditingUserId];
            }
            
            // The real-time listener will handle the UI update automatically
            closeModal('unverifyUserModal');
            showSuccess('تم إلغاء توثيق الحساب بنجاح وسيتم إزالة علامة التوثيق من جميع أنحاء الموقع');
            
        } catch (error) {
            console.error('Error unverifying user:', error);
            showError('حدث خطأ أثناء إلغاء التوثيق');
        }
    }

    // Toggle user ban status
    async function toggleBanUser(userId, isBanned) {
        try {
            const banData = {
                banned: !isBanned,
                banUpdatedAt: Date.now()
            };
            
            // Update data in Firebase
            await db.ref(`users/${userId}`).update(banData);
            
            showSuccess(isBanned ? 'تم فك حظر المستخدم بنجاح' : 'تم حظر المستخدم بنجاح');
            
        } catch (error) {
            console.error('Error toggling user ban:', error);
            showError('حدث خطأ أثناء تغيير حالة الحظر');
        }
    }

    // Refresh all data
    function refreshData() {
        currentPage = 1;
        document.getElementById('searchInput').value = '';
        loadUsers();
        showSuccess('تم تحديث البيانات بنجاح');
    }

    // Helper function to format date
    function formatDate(timestamp) {
        if (!timestamp) return 'غير معروف';
        const date = new Date(timestamp);
        return date.toLocaleDateString('ar-EG') + ' ' + date.toLocaleTimeString('ar-EG');
    }

    // Modal functions
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // Notification functions
    function showSuccess(message) {
        const successMessage = document.getElementById('successMessage');
        const successText = document.getElementById('successMessageText');
        successText.textContent = message;
        successMessage.style.display = 'block';
        successMessage.style.backgroundColor = 'var(--success-color)';
        
        setTimeout(() => {
            successMessage.style.display = 'none';
        }, 3000);
    }

    function showError(message) {
        const successMessage = document.getElementById('successMessage');
        const successText = document.getElementById('successMessageText');
        successText.textContent = message;
        successMessage.style.backgroundColor = 'var(--danger-color)';
        successMessage.style.display = 'block';
        
        setTimeout(() => {
            successMessage.style.display = 'none';
            successMessage.style.backgroundColor = 'var(--success-color)';
        }, 3000);
    }
</script>
</body>
</html>
